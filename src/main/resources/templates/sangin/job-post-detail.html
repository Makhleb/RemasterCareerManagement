<!DOCTYPE html>
<html lang="en"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout_dir/layout/main_layout}">
<head>
    <meta charset="UTF-8">
    <title>공고 상세 보기</title>
    <link rel="stylesheet" href="/css/job-post-detail.css">
</head>
<body layout:fragment="content" th:attr="data-job-post-no=${jobPostNo}">
<section>
    <div class="section1">
        <div id="post_img"></div>
    </div>
    <div class="section2">
        <div class="section2_box1">
            <div id="com_name"></div>
            <div class="request">
                <span id="post_address"></span>
                <span id="job_history"></span>
            </div>
        </div>
        <div class="section2_box2">
            <div id="post_name"></div>
            <span id="section2_regist" class="regist">지원하기</span>
        </div>
    </div>
    <div class="section3">
        <div id="section3_text">포지션 상세</div>
        <div id="description"></div>
    </div>
    <div class="section4">
        <div id="section4_text">기술 스택 · 툴</div>
        <div id="stack_list"></div>
    </div>
    <div class="section5">
        <div id="section5_text">복리 후생</div>
        <div id="benefit_list"></div>
    </div>
    <div class="section6">
        <div id="section6_text">근무지역</div>
        <div id="map"></div>
        <div id="region_name"></div>
    </div>
    <div class="section7">
        <span class="regist">지원하기</span>
    </div>
    <!-- 모달창 -->
    <div id="resume-modal" class="modal">
        <div class="modal-content">
            <div style="display: flex; gap: 20px; align-items: center; justify-content: center;">
                <h2>이력서 선택</h2>
                <div class="close">&times;</div>
            </div>
            <ul id="resume-list"></ul>
            <button id="apply-btn">지원하기</button>
        </div>
    </div>
    <script>
        // 공통 변수 정의
        const modal = document.getElementById("resume-modal");
        const closeModal = document.querySelector(".close");
        const applyBtn = document.getElementById("apply-btn");
        const resumeList = document.getElementById("resume-list");
        const jobPostNo = document.body.dataset.jobPostNo; // 공고 번호를 body의 dataset에서 가져오기

        axios.get(`/api/users/job-post/detail/${jobPostNo}`)
            .then(response => {
                const data = response.data;

                document.getElementById("post_img").innerHTML = `<img src="/images/${data.postThumbnail}" alt="공고 이미지">`;
                document.getElementById("com_name").textContent = data.companyName;
                document.getElementById("post_address").textContent = data.postAddress;
                document.getElementById("job_history").textContent = data.jobHistory;
                document.getElementById("post_name").textContent = data.title;
                document.getElementById("description").textContent = data.content;
                document.getElementById("region_name").textContent = data.postAddressDetail;

                const stackList = document.getElementById("stack_list");
                data.skillList.forEach(skill => {
                    const span = document.createElement("span");
                    span.textContent = skill.skillCode;
                    stackList.appendChild(span);
                });
                const benefitList = document.getElementById("benefit_list");
                data.benefitList.forEach(benefit => {
                    const span = document.createElement("span");
                    span.textContent = benefit.benefitContent;
                    benefitList.appendChild(span);
                });

            })
            .catch(error => console.error("Error fetching job post details:", error));

        // 이력서 목록 로드
        function loadResumes() {
            resumeList.innerHTML = ""; // 기존 목록 초기화

            // Axios 요청으로 이력서 목록 가져오기
            axios.get("/api/users/job-post/resume/list")
                .then(response => {
                    const resumes = response.data;

                    resumes.forEach(resume => {
                        const li = document.createElement("li");
                        li.textContent = resume.title; // title 사용
                        li.dataset.resumeNo = resume.resumeNo; // resumeNo를 dataset에 저장
                        li.addEventListener("click", () => {
                            document.querySelectorAll("#resume-list li").forEach(item => {
                                item.style.backgroundColor = "";
                                item.dataset.selected = "false";
                            });
                            li.style.backgroundColor = "#d1f7d1"; // 선택된 이력서 강조
                            li.dataset.selected = "true";
                        });
                        resumeList.appendChild(li); // 목록에 추가
                    });
                })
                .catch(error => console.error("Error fetching resume list:", error));
        }

        // '지원하기' 버튼 클릭 시 모달 열기
        document.querySelectorAll(".regist").forEach(regist => {
            regist.addEventListener("click", () => {
                loadResumes(); // 이력서 목록 로드
                modal.style.display = "block";
            });
        });

        // 모달 닫기
        closeModal.addEventListener("click", () => {
            modal.style.display = "none";
        });

        // 이력서 선택 후 지원하기
        applyBtn.addEventListener("click", () => {
            const selectedResume = document.querySelector("#resume-list li[data-selected='true']");
            if (selectedResume) {
                // 선택된 이력서 정보 확인 및 확인창 표시
                const resumeNo = selectedResume.dataset.resumeNo;
                const confirmApply = window.confirm(
                    `[ ${selectedResume.textContent} ] 로 지원하시겠습니까?`
                );

                if (confirmApply) {
                    // Axios 요청으로 지원 데이터 전송
                    axios.post("/api/users/job-post/resume/regist", {
                        jobPostNo: jobPostNo,
                        resumeNo: resumeNo
                    })
                        .then(() => {
                            alert("지원이 완료되었습니다!");
                            modal.style.display = "none";
                        })
                        .catch(error => {
                            console.error("Error during application:", error);
                            alert("지원 중 문제가 발생했습니다. 다시 시도해주세요.");
                        });
                }
            } else {
                alert("이력서를 선택해주세요!");
            }
        });

        // 모달 외부 클릭 시 닫기
        window.addEventListener("click", event => {
            if (event.target === modal) {
                modal.style.display = "none";
            }
        });
    </script>

</section>
</body>
</html>
