<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout_dir/layout/main_layout}">
<head>
    <meta charset="UTF-8">
    <title>ì±„ìš© ê³µê³  ëª©ë¡</title>
    <link rel="stylesheet" th:href="@{/css/job-post-list.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body layout:fragment="content">
<section>
    <div class="section1">
        <div id="kind">ğŸ”&nbsp;&nbsp;ê²€ìƒ‰ì–´</div>
        <span class="separator">|</span>
        <div id="keyword"></div>
    </div>
    <div class="section2">
        <div class="section2_option_container">
            <div class="section2_option" id="region_bar">
                <i class="fa-solid fa-location-dot" style="color: #4CAF50;"></i>&nbsp;&nbsp;ì§€ì—­ì„ íƒ
            </div>
            <div class="section2_option" id="job_bar">
                <i class="fa-solid fa-briefcase" style="color: #2196F3;"></i>&nbsp;&nbsp;ì§ì—…ì„ íƒ
            </div>
            <div class="section2_option" id="search_bar">ê²€ìƒ‰ì–´ì…ë ¥</div>
        </div>
        <div class="section2_region_option section2_none">
            <div class="region" value="ì„œìš¸">ì„œìš¸</div>
            <div class="region" value="ì¸ì²œ">ì¸ì²œ</div>
            <div class="region" value="ëŒ€êµ¬">ëŒ€êµ¬</div>
            <div class="region" value="ëŒ€ì „">ëŒ€ì „</div>
            <div class="region" value="ì„¸ì¢…">ì„¸ì¢…</div>
            <div class="region" value="ê²½ë‚¨">ê²½ë‚¨</div>
            <div class="region" value="ì „ë‚¨">ì „ë‚¨</div>
            <div class="region" value="ê²½ê¸°">ê²½ê¸°</div>
            <div class="region" value="ë¶€ì‚°">ë¶€ì‚°</div>
            <div class="region" value="ê´‘ì£¼">ê´‘ì£¼</div>
            <div class="region" value="ìš¸ì‚°">ìš¸ì‚°</div>
            <div class="region" value="ê°•ì›">ê°•ì›</div>
            <div class="region" value="ê²½ë¶">ê²½ë¶</div>
            <div class="region" value="ì „ë¶">ì „ë¶</div>
            <div class="region" value="ì¶©ë‚¨">ì¶©ë‚¨</div>
            <div class="region" value="ì¶©ë¶">ì¶©ë¶</div>
            <div class="region" value="ì œì£¼">ì œì£¼</div>
        </div>
        <div class="section2_job_option section2_none">
            <div class="job" value="ê°œë°œ">ê°œë°œ</div>
            <div class="job" value="ê²½ì˜">ê²½ì˜Â·ë¹„ì¦ˆë‹ˆìŠ¤</div>
            <div class="job" value="ë§ˆì¼€íŒ…">ë§ˆì¼€íŒ…Â·ê´‘ê³ </div>
            <div class="job" value="ë””ìì¸">ë””ìì¸</div>
            <div class="job" value="ì˜ì—…">ì˜ì—…</div>
            <div class="job" value="ê³ ê°ì„œë¹„ìŠ¤">ê³ ê°ì„œë¹„ìŠ¤Â·ë¦¬í…Œì¼</div>
            <div class="job" value="ì—”ì§€ë‹ˆì–´ë§">ì—”ì§€ë‹ˆì–´ë§Â·ì„¤ê³„</div>
            <div class="job" value="ì œì¡°">ì œì¡°Â·ìƒì‚°</div>
            <div class="job" value="ì˜ë£Œ">ì˜ë£ŒÂ·ì œì•½Â·ë°”ì´ì˜¤</div>
        </div>
        <div class="section2_container">
            <div id="keyword_container"></div>
            <div id="section2_btn">ê²€ìƒ‰</div>
        </div>
    </div>
    <div class="section3">
        <div id="section3_description">
            <img th:src="@{/images/fire.png}" alt="ë¶ˆ">
            <div>íšŒì›ë‹˜ì„ ìœ„í•œ ì¶”ì²œ ê³µê³ </div>
        </div>
        <div id="section3_option">
            <div class="section3_option" style="border-right: 1px #ddd solid;  border-radius: 10px 0px 0px 10px;">
                ì¶”ì²œìˆœ
            </div>
            <div class="section3_option" style="border-right: 1px #ddd solid;">ìµœì‹ ìˆœ</div>
            <div class="section3_option" style="border-radius: 0 10px 10px 0;">ì¸ê¸°ìˆœ</div>
        </div>
    </div>
    <div class="section4">
        <!--    ì¸ê¸° ê³µê³ ê°€ ìƒì„±ë©ë‹ˆë‹¤    -->
    </div>
    <div class="section5">
        <!--    ì „ì²´ ê³µê³ ê°€ ìƒì„±ë©ë‹ˆë‹¤    -->
    </div>
</section>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const section4Container = document.querySelector('.section4');
        const section5Container = document.querySelector('.section5');
        const keywordDisplay = document.querySelector("#keyword");

        // URLì—ì„œ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const keyword = urlParams.get('keyword') || ''; // 'keyword' íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´

        // íŒŒë¼ë¯¸í„°ë¥¼ í™”ë©´ì— í‘œì‹œ
        if (keyword) {
            keywordDisplay.textContent = keyword;
        } else {
            keywordDisplay.textContent = "ê²€ìƒ‰ ì¡°ê±´ ì—†ìŒ";
        }

        // ì¶”ì²œ ê³µê³  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        axios.get('/api/users/job-post/list/matching')
            .then(response => {
                const data = response.data;
                section4Container.innerHTML = '';
                data.slice(0, 4).forEach(item => {
                    const postDiv = document.createElement('div');
                    postDiv.classList.add('section4_popular');
                    postDiv.dataset.jobPostNo = item.jobPostNo;

                    postDiv.style.backgroundImage = `url(${item.postThumbnail})`;
                    postDiv.style.backgroundSize = 'cover'; // ë°°ê²½ ì´ë¯¸ì§€ê°€ divì— ë§ê²Œ ì¡°ì •ë¨
                    postDiv.style.backgroundPosition = 'center'; // ì´ë¯¸ì§€ì˜ ì¤‘ì‹¬ì„ ê¸°ì¤€ìœ¼ë¡œ ë°°ì¹˜
                    postDiv.style.backgroundRepeat = 'no-repeat'; // ë°˜ë³µ ê¸ˆì§€

                    postDiv.innerHTML = `
                    <div id="section4_fake">    <i class="fa-solid fa-fire" style="color: orange;"></i>&nbsp;&nbsp;ì¸ê¸° ìˆëŠ”</div>
                    <div id="section4_companyImage"><img src="${item.companyImage}" alt="ë¡œê³ "></div>
                    <a id="section4_title" href="/view/users/job-post/detail/${item.jobPostNo}">${item.title}</a>
                    <div id="section4_companyName"><a href="/view/users/company/detail/${item.companyId}"><i class="fa-solid fa-building"></i>&nbsp;&nbsp;${item.companyName}</a></div>
                    <div id="section4_footer_left"><i class="fa-solid fa-bomb" style="color: blue;"></i>&nbsp;ë²¼ë½ë¶€ì/ê°€ëŠ¥</div>
                `;
                    section4Container.appendChild(postDiv);
                });
            })
            .catch(error => {
                console.error(error);
            });

        // ì „ì²´ ê³µê³  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function fetchJobPosts(keyword = '') {
            axios.get(`/api/users/job-post/list/all`, {params: {keyword}})
                .then(response => {
                    const data = response;
                    section5Container.innerHTML = '';
                    if (data.length === 0) {
                        section5Container.innerHTML = '<div>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }
                    data.data.forEach(item => {
                        const postDiv = document.createElement('div');
                        postDiv.classList.add('section5_post');
                        postDiv.dataset.jobPostNo = item.jobPostNo;

                        // ìŠ¤í¬ë© ìƒíƒœì— ë”°ë¼ ì•„ì´ì½˜ ê²°ì •
                        const starIcon = item.isScraped === 1
                            ? '<i class="fa-solid fa-star"></i>'
                            : '<i class="fa-regular fa-star"></i>';

                        postDiv.innerHTML = `
                        <div id="section5_companyImage">
                            <img src="${item.companyImage}" alt="ë¡œê³ ">
                        </div>
                        <a id="section5_title" href="/view/users/job-post/detail/${item.jobPostNo}">${item.title}</a>
                        <div id="section5_postAddress"><i class="fa-solid fa-location-dot"></i>&nbsp;&nbsp;${item.postAddress}</div>
                        <div id="section5_educationName"><i class="fa-solid fa-school"></i>&nbsp;&nbsp;${item.educationName} ì´ìƒ</div>
                        <div class="section5_footer">
                            <div id="section5_footer_left"><i class="fa-solid fa-bomb" style="color: #ff7300;"></i>&nbsp;ì„±ê³¼ê¸‰/ìƒì—¬ê¸ˆ</div>
                            <div id="section5_footer_right">
                                <div id="section5_endDate">${item.endDate ? `~${new Date(item.endDate).toLocaleDateString()}` : 'ë§ˆê°ì¼ ì—†ìŒ'}</div>
                                <div id="section5_star" class="${item.isScraped === 1 ? 'colorstar' : 'uncolorstar'}">${starIcon}</div>
                            </div>
                        </div>
                    `;
                        section5Container.appendChild(postDiv);
                    });
                })
                .catch(error => {
                    console.error(error);
                    alert('ê³µê³ ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                });
        }


        // ì´ˆê¸° ì „ì²´ ê³µê³  ë¡œë“œ (URLì—ì„œ ë°›ì€ keyword ì‚¬ìš©)
        fetchJobPosts(keyword);

        // ìŠ¤í¬ë© ì¶”ê°€/ì‚­ì œ ìš”ì²­ í•¨ìˆ˜
        function toggleScrap(jobPostNo, isScraped) {
            const url = isScraped
                ? `/api/users/like/jpl/remove?jobPostNo=${jobPostNo}`
                : `/api/users/like/jpl/add?jobPostNo=${jobPostNo}`;

            return axios.get(url)
                .then(response => {
                    console.log(response.data);
                })
                .catch(error => {
                    console.error('Error in toggleScrap:', error);
                    throw error;
                });
        }

        section5Container.addEventListener("click", (event) => {
            // í´ë¦­ëœ ìš”ì†Œì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ #section5_star ì°¾ê¸°
            const star = event.target.closest("#section5_star");

            if (star && (star.classList.contains("colorstar") || star.classList.contains("uncolorstar"))) {
                const jobPostNo = star.closest(".section5_post").dataset.jobPostNo;
                const isScraped = star.classList.contains("colorstar");

                toggleScrap(jobPostNo, isScraped)
                    .then(() => {
                        star.classList.toggle("colorstar");
                        star.classList.toggle("uncolorstar");

                        if (star.classList.contains("colorstar")) {
                            star.innerHTML = '<i class="fa-solid fa-star"></i>';
                            alert("ë¶ë§ˆí¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        } else {
                            star.innerHTML = '<i class="fa-regular fa-star"></i>';
                            alert("ë¶ë§ˆí¬ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        }
                    })
                    .catch(error => {
                        console.error("ìŠ¤í¬ë© ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:", error);
                    });
            }
        });



        // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
        document.querySelector("#section2_btn").addEventListener("click", () => {
            const keyword = keywordDisplay.textContent.replace("ê²€ìƒ‰ì–´: ", "").trim();
            fetchJobPosts(keyword);
        });

        // ê²€ìƒ‰ì–´ ì…ë ¥ ë° ì²˜ë¦¬
        const search_bar = document.querySelector("#search_bar");
        search_bar.addEventListener("click", () => {
            const input = document.createElement("input");
            input.type = "text";
            input.placeholder = "ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”";
            input.classList.add("section2_option");

            input.addEventListener("input", () => {
                const value = input.value.trim();
                keywordDisplay.textContent = value ? value : "ê²€ìƒ‰ ì¡°ê±´ ì—†ìŒ";
                fetchJobPosts(value);
            });

            input.addEventListener("blur", () => {
                const value = input.value.trim();
                search_bar.textContent = value || "ê²€ìƒ‰ì–´ì…ë ¥";
                keywordDisplay.textContent = value ? value : "ê²€ìƒ‰ ì¡°ê±´ ì—†ìŒ";
                input.replaceWith(search_bar);
            });

            search_bar.replaceWith(input);
            input.focus();
        });

        // ë“œë¡­ë‹¤ìš´ ê¸°ëŠ¥
        const region_bar = document.querySelector("#region_bar");
        const section2_region_option = document.querySelector(".section2_region_option");
        const job_bar = document.querySelector("#job_bar");
        const section2_job_option = document.querySelector(".section2_job_option");

        region_bar.addEventListener("click", () => {
            if (section2_region_option.classList.contains("section2_none")) {
                section2_job_option.classList.add("section2_none");
                section2_region_option.classList.remove("section2_none");
                section2_region_option.classList.add("section2_block");
            } else {
                section2_region_option.classList.add("section2_none");
                section2_region_option.classList.remove("section2_block");
            }
        });

        job_bar.addEventListener("click", () => {
            if (section2_job_option.classList.contains("section2_none")) {
                section2_region_option.classList.add("section2_none");
                section2_job_option.classList.remove("section2_none");
                section2_job_option.classList.add("section2_block");
            } else {
                section2_job_option.classList.add("section2_none");
                section2_job_option.classList.remove("section2_block");
            }
        });

        // ì§€ì—­ ë° ì§ì—… ì„ íƒ ì´ë²¤íŠ¸
        document.querySelectorAll(".region, .job").forEach(option => {
            option.addEventListener("click", () => {
                const value = option.getAttribute("value");
                keyword_container.textContent = value;
                keywordDisplay.textContent = value;
            });
        });
    });
</script>
</body>
</html>
