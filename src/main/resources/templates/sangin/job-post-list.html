<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout_dir/layout/main_layout}">
<head>
    <meta charset="UTF-8">
    <title>채용 공고 목록</title>
    <link rel="stylesheet" th:href="@{/css/job-post-list.css}">
</head>
<body layout:fragment="content">
<section>
    <div class="section1">
        <div id="kind">검색어</div>
        <span class="separator">|</span>
        <div id="keyword"></div>
    </div>
    <div class="section2">
        <div class="section2_option_container">
            <div class="section2_option" id="region_bar">
                지역선택
            </div>
            <div class="section2_option" id="job_bar">
                직업선택
            </div>
            <div class="section2_option" id="search_bar">검색어입력</div>
        </div>
        <div class="section2_region_option section2_none">
            <div class="region" value="서울">서울</div>
            <div class="region" value="인천">인천</div>
            <div class="region" value="대구">대구</div>
            <div class="region" value="대전">대전</div>
            <div class="region" value="세종">세종</div>
            <div class="region" value="경남">경남</div>
            <div class="region" value="전남">전남</div>
            <div class="region" value="경기">경기</div>
            <div class="region" value="부산">부산</div>
            <div class="region" value="광주">광주</div>
            <div class="region" value="울산">울산</div>
            <div class="region" value="강원">강원</div>
            <div class="region" value="경북">경북</div>
            <div class="region" value="전북">전북</div>
            <div class="region" value="충남">충남</div>
            <div class="region" value="충북">충북</div>
            <div class="region" value="제주">제주</div>
        </div>
        <div class="section2_job_option section2_none">
            <div class="job" value="개발">개발</div>
            <div class="job" value="경영">경영·비즈니스</div>
            <div class="job" value="마케팅">마케팅·광고</div>
            <div class="job" value="디자인">디자인</div>
            <div class="job" value="영업">영업</div>
            <div class="job" value="고객서비스">고객서비스·리테일</div>
            <div class="job" value="엔지니어링">엔지니어링·설계</div>
            <div class="job" value="제조">제조·생산</div>
            <div class="job" value="의료">의료·제약·바이오</div>
        </div>
        <div class="section2_container">
            <div id="keyword_container"></div>
            <div id="section2_btn">검색</div>
        </div>
    </div>
    <div class="section3">
        <div id="section3_description">
            <img th:src="@{/images/fire.png}" alt="불">
            <div>회원님을 위한 공고</div>
        </div>
        <div id="section3_option">
            <div class="section3_option" style="border-right: 1px #ddd solid;  border-radius: 10px 0px 0px 10px;">
                추천순
            </div>
            <div class="section3_option" style="border-right: 1px #ddd solid;">최신순</div>
            <div class="section3_option" style="border-radius: 0 10px 10px 0;">인기순</div>
        </div>
    </div>
    <div class="section4">
        <!--    인기 공고가 생깁니다    -->
    </div>
    <div class="section5">
        <!--    전체 공고가 생깁니다   -->
    </div>
</section>
<script>
    const section4Container = document.querySelector('.section4');
    const section5Container = document.querySelector('.section5');

    // 추천 공고 데이터 가져오기
    axios.get('/api/users/job-post/list/matching')
        .then(response => {
            const data = response.data;
            section4Container.innerHTML = '';
            data.slice(0, 4).forEach(item => {
                const postDiv = document.createElement('div');
                postDiv.classList.add('section4_popular');
                postDiv.dataset.jobPostNo = item.jobPostNo;
                postDiv.innerHTML = `
                    <div id="section4_fake">추천 공고</div>
                    <div id="section4_postThumbnail"><img src="/images/${item.postThumbnail}" alt="기업로고"></div>
                    <a id="section4_title" href="/view/users/job-post/detail/${item.jobPostNo}">${item.title}</a>
                    <div id="section4_companyName">${item.companyName}</div>
                `;
                section4Container.appendChild(postDiv);
            });
        })
        .catch(error => {
            console.error(error);
            alert('추천 공고를 불러오지 못했어요');
        });

    // 전체 공고 데이터 가져오기
    axios.get('/api/users/job-post/list/all')
        .then(response => {
            const data = response.data;
            section5Container.innerHTML = '';
            data.forEach(item => {
                const postDiv = document.createElement('div');
                postDiv.classList.add('section5_post');
                postDiv.dataset.jobPostNo = item.jobPostNo;
                postDiv.innerHTML = `
                    <div id="section5_postThumbnail">
                        <img src="/images/${item.postThumbnail}" alt="기업로고">
                    </div>
                    <a id="section5_title" href="/view/users/job-post/detail/${item.jobPostNo}">${item.title}</a>
                    <div id="section5_postAddress">${item.postAddress}</div>
                    <div id="section5_educationName">${item.educationName} 이상</div>
                    <div class="section5_footer">
                        <div id="section5_footer_left">성과급/상여금</div>
                        <div id="section5_footer_right">
                            <div id="section5_endDate">${item.endDate ? `~${new Date(item.endDate).toLocaleDateString()}` : '마감일 없음'}</div>
                            <div id="section5_star" class="${item.isScraped == 1 ? 'colorstar' : 'uncolorstar'}"></div>
                        </div>
                    </div>
                `;
                section5Container.appendChild(postDiv);

                // 스크랩 클릭 이벤트 추가
                const scrapStar = postDiv.querySelector('#section5_star');
                scrapStar.addEventListener('click', () => {
                    const isScraped = scrapStar.classList.contains('colorstar');
                    toggleScrap(item.jobPostNo, isScraped)
                        .then(() => {
                            if (isScraped) {
                                scrapStar.classList.remove('colorstar');
                                scrapStar.classList.add('uncolorstar');
                                alert('공고가 스크랩되었습니다!');
                            } else {
                                scrapStar.classList.remove('uncolorstar');
                                scrapStar.classList.add('colorstar');
                                alert('공고 스크랩이 취소되었습니다.');
                            }
                        })
                        .catch(() => {
                            alert('스크랩 작업 중 오류가 발생했습니다.');
                        });
                });
            });
        })
        .catch(error => {
            console.error(error);
            alert('Error fetching all posts');
        });

    // 스크랩 추가/삭제 요청 함수
    function toggleScrap(jobPostNo, isScraped) {
        const url = isScraped
            ? `/api/users/like/jpl/remove?jobPostNo=${jobPostNo}`
            : `/api/users/like/jpl/add?jobPostNo=${jobPostNo}`;

        return axios.get(url)
            .then(response => {
                console.log(response.data);
            })
            .catch(error => {
                console.error('Error in toggleScrap:', error);
                throw error;
            });
    }
</script>
</body>
</html>
