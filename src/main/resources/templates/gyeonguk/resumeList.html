<!DOCTYPE html>
<html lang="ko"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout_dir/layout/main_layout}">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" th:href="@{/css/resume-list.css}">
</head>
<body layout:fragment="content">
<h1>이력서 리스트</h1>

<!-- 대표이력서 설정 버튼 -->
<button id="toggleRepresentative" onclick="toggleRepresentativeMode()">대표이력서 설정</button>

<!-- 이력서 리스트 -->
<div id="resumeList">로딩중...</div>

<!-- 알림창 -->
<div id="confirmationPopup" style="display: none;">
    <p>변경하시겠습니까?</p>
    <button onclick="confirmRepresentative()">확인</button>
    <button onclick="cancelRepresentative()">취소</button>
</div>

<script>
    let isRepresentativeMode = false; // 대표이력서 설정 모드 상태
    let selectedResumeId = null; // 선택된 이력서 ID

    // 이력서 리스트를 가져옵니다
    function loadResumeList() {
        const userId = 'test1'; // 실제 사용자 ID를 대체
        axios.get(`/api/users/resume/list/${userId}`)
            .then(response => {
                console.log(response.data);
                const resumes = response.data;
                const resumeListDiv = document.getElementById('resumeList');
                resumeListDiv.innerHTML = ''; // 기존 내용을 초기화

                if (resumes.length > 0) {
                    resumes.forEach(resume => {
                        const div = document.createElement('div');
                        console.log("resume" + resume);
                        div.innerHTML = `
                            <div style="margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px;">
                                ${isRepresentativeMode ? `<input type="radio" name="representative" value="${resume.resumeNo}" onclick="selectResume(${resume.resumeNo})">` : ''}
                                <strong>${resume.title}</strong>
                                - <span>${new Date(resume.createDate).toLocaleDateString()}</span>
                            </div>
                        `;
                        resumeListDiv.appendChild(div);
                    });
                } else {
                    resumeListDiv.innerHTML = '등록된 이력서가 없습니다.';
                }
            })
            .catch(error => {
                console.error('이력서 조회 중 오류:', error);
                const resumeListDiv = document.getElementById('resumeList');
                resumeListDiv.innerHTML = '이력서를 가져오는 데 실패했습니다. 다시 시도해 주세요.';
            });
    }

    // 대표이력서 설정 버튼을 클릭했을 때
    function toggleRepresentativeMode() {
        isRepresentativeMode = !isRepresentativeMode; // 모드 토글
        const button = document.getElementById('toggleRepresentative');
        button.textContent = isRepresentativeMode ? '변경' : '대표이력서 설정';

        if (isRepresentativeMode) {
            document.getElementById('confirmationPopup').style.display = 'block';
        } else {
            document.getElementById('confirmationPopup').style.display = 'none';
        }
        loadResumeList(); // 리스트를 다시 로드
    }

    // 특정 이력서를 선택
    function selectResume(resumeId) {
        selectedResumeId = resumeId;
        console.log('선택된 이력서 ID:', selectedResumeId);
    }

    // 확인 버튼을 클릭했을 때
    function confirmRepresentative() {
        if (selectedResumeId === null) {
            alert('대표 이력서를 선택해주세요.');
            return;
        }
        // 알림창 표시
        document.getElementById('confirmationPopup').style.display = 'block';
        console.log('알림창 표시 상태:', document.getElementById('confirmationPopup').style.display);

        axios.put('/api/users/resume/representative', { resumeNo: selectedResumeId, userId: "test1"})
            .then(response => {
                console.log('서버 응답:', response.data); // 서버 응답 디버깅
                if (response.data === '대표 이력서가 설정되었습니다.') {
                    alert('대표 이력서가 설정되었습니다.');
                    document.getElementById('confirmationPopup').style.display = 'none';
                    isRepresentativeMode = false;
                    loadResumeList(); // 업데이트된 리스트 다시 로드
                } else {
                    alert('대표 이력서 설정 중 문제가 발생했습니다.'); // 비정상적인 응답 처리
                }
            })
            .catch(error => {
                console.error('대표 이력서 설정 오류:', error);
                alert('대표 이력서를 설정하는 데 실패했습니다.');
            });
    }

    // 취소 버튼을 클릭했을 때
    function cancelRepresentative() {
        document.getElementById('confirmationPopup').style.display = 'none';
    }

    // 페이지 로드 시 이력서 리스트를 가져옴
    window.onload = loadResumeList;
</script>
</body>
</html>
